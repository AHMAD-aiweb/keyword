<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoSystem - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom theme colors */
        .bg-primary-green { background-color: #10EF52; }
        .bg-primary-blue { background-color: #103EEF; }
        .bg-primary-pink { background-color: #EF10AD; }
        .bg-primary-yellow { background-color: #EFC110; }
        .text-primary-blue { color: #103EEF; }
        .border-primary-blue { border-color: #103EEF; }
        .hover-bg-primary-blue-dark:hover { background-color: #0d32c6; }

        /* Navbar active link style */
        .nav-link.active {
            color: #103EEF;
            border-bottom: 2px solid #103EEF;
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
            padding-bottom: 4px;
            border-bottom: 2px solid transparent;
        }
        .nav-link:hover { color: #103EEF; }

        /* Card styles */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        /* Toast notification */
        #toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); padding: 12px 24px;
            border-radius: 8px; color: white; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        #toast.show { opacity: 1; visibility: visible; }
        #toast.success { background-color: #10b981; }
        #toast.error { background-color: #ef4444; }

        /* Progress Bar */
        .progress-bar-bg { background-color: #e5e7eb; }
        .progress-bar-fill {
            background-color: #10EF52;
            transition: width 0.5s ease-in-out;
        }
        
        /* Tier Card Icons */
        .tier-icon {
            border-radius: 50%; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem;
        }
        .tier-icon.starter { background-color: #6b7280; }
        .tier-icon.bronze { background-color: #cd7f32; }
        .tier-icon.silver { background-color: #c0c0c0; }
        .tier-icon.gold { background: linear-gradient(145deg, #ffd700, #f0c400); }
        .tier-icon.diamond { background: linear-gradient(145deg, #b9f2ff, #8cf0ff); }

        /* Notification Timeline */
        .timeline { border-left: 2px solid #e5e7eb; }
        .timeline-item { position: relative; padding-left: 2rem; padding-bottom: 1.5rem; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-dot {
            position: absolute; left: -9px; top: 4px;
            height: 16px; width: 16px; border-radius: 9999px;
            background-color: white; border: 3px solid #d1d5db;
        }
        .timeline-item.unread .timeline-dot { border-color: #103EEF; }
        .timeline-item.unread { font-weight: 600; }
    </style>
</head>
<body>

    <div id="app-container" class="hidden min-h-screen flex flex-col">
        <!-- Header / Navbar -->
        <header class="bg-white shadow-md sticky top-0 z-50">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="#" class="text-2xl font-bold"><span class="text-primary-blue">Auto</span><span style="color: #10EF52;">System</span></a>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#main" class="nav-link text-gray-700 font-medium px-3 py-2 text-sm">Main</a>
                            <a href="#dashboard" class="nav-link text-gray-700 font-medium px-3 py-2 text-sm">Dashboard</a>
                            <a href="#notification" class="nav-link text-gray-700 font-medium px-3 py-2 text-sm">Notification</a>
                            <a href="#setting" class="nav-link text-gray-700 font-medium px-3 py-2 text-sm">Setting</a>
                        </div>
                    </div>
                    <div class="flex items-center">
                         <div id="user-menu" class="relative hidden md:block">
                            <button id="user-menu-button" class="flex items-center space-x-2">
                                <span id="nav-username" class="font-medium text-gray-700"></span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1">
                                <a href="#setting" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Settings</a>
                                <button id="nav-logout-btn" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
                            </div>
                        </div>
                        <button id="mobile-menu-button" class="md:hidden ml-4 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                            <i class="fas fa-bars fa-lg"></i>
                        </button>
                    </div>
                </div>
            </nav>
            <div id="mobile-menu" class="md:hidden hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#main" class="nav-link-mobile block px-3 py-2 rounded-md text-base font-medium text-gray-700">Main</a>
                    <a href="#dashboard" class="nav-link-mobile block px-3 py-2 rounded-md text-base font-medium text-gray-700">Dashboard</a>
                    <a href="#notification" class="nav-link-mobile block px-3 py-2 rounded-md text-base font-medium text-gray-700">Notification</a>
                    <a href="#setting" class="nav-link-mobile block px-3 py-2 rounded-md text-base font-medium text-gray-700">Setting</a>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="page-main" class="page-content hidden"></div>
            <div id="page-dashboard" class="page-content hidden"></div>

            <div id="page-notification" class="page-content hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Your Notifications</h1>
                <div class="card">
                    <div id="notifications-container" class="timeline">
                        <!-- Notifications will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <div id="page-setting" class="page-content hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Settings</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Update Profile -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Update Profile</h2>
                        <form id="update-profile-form" class="space-y-4">
                            <div>
                                <label for="profile-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                                <input type="tel" id="profile-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="profile-address" class="block text-sm font-medium text-gray-700">Address</label>
                                <input type="text" id="profile-address" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button type="submit" class="w-full bg-primary-blue text-white font-semibold py-2 px-4 rounded-md hover-bg-primary-blue-dark transition-colors">Save Changes</button>
                        </form>
                    </div>
                    <!-- Change Password -->
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Change Password</h2>
                        <form id="change-password-form" class="space-y-4">
                            <div>
                                <label for="current-password" class="block text-sm font-medium text-gray-700">Current Password</label>
                                <input type="password" id="current-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                                <input type="password" id="new-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button type="submit" class="w-full bg-primary-pink text-white font-semibold py-2 px-4 rounded-md hover:bg-pink-700 transition-colors">Update Password</button>
                        </form>
                    </div>
                </div>
                 <div class="mt-6 card">
                    <h2 class="text-xl font-semibold mb-4">Account</h2>
                    <button id="logout-btn" class="w-full bg-primary-yellow text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-yellow-500 transition-colors">Logout</button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white"></footer>
    </div>
    
    <div id="loader" class="flex items-center justify-center min-h-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary-blue"></div>
    </div>
    <div id="toast"></div>

    <script type="module">
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyB1SFpdzDcJ_lfVu1dLo7zgQhqQ6WiwiGE",
            authDomain: "autosys-31e7e.firebaseapp.com",
            databaseURL: "https://autosys-31e7e-default-rtdb.firebaseio.com",
            projectId: "autosys-31e7e",
            storageBucket: "autosys-31e7e.appspot.com",
            messagingSenderId: "532724704349",
            appId: "1:532724704349:web:58f6bbc554c79d79ef19b4",
            measurementId: "G-MLTN241WJR"
        };

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, serverTimestamp, update, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Global Variables & DOM Elements ---
        let currentUserId = null;
        let userData = null;
        const loader = document.getElementById('loader');
        const appContainer = document.getElementById('app-container');
        const toastEl = document.getElementById('toast');
        const notificationsContainer = document.getElementById('notifications-container');
        const updateProfileForm = document.getElementById('update-profile-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const logoutBtn = document.getElementById('logout-btn');
        const navLogoutBtn = document.getElementById('nav-logout-btn');
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const navUsername = document.getElementById('nav-username');

        // --- Auth State Observer ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                loader.classList.add('hidden');
                appContainer.classList.remove('hidden');
                listenToUserData(currentUserId);
            } else {
                window.location.replace('index.html');
            }
        });

        // --- Realtime Data Listener ---
        function listenToUserData(userId) {
            const userRef = ref(db, 'users/' + userId);
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    // Update UI elements that depend on user data
                    navUsername.textContent = userData.firstName;
                    document.getElementById('user-menu').classList.remove('hidden');
                    // Pre-fill settings forms
                    if (document.getElementById('profile-phone')) {
                        document.getElementById('profile-phone').value = userData.phone || '';
                        document.getElementById('profile-address').value = userData.address || '';
                    }
                    // Load notifications
                    loadNotifications(userId, userData.notifications || {});
                }
            });
        }
        
        // --- Settings Page Logic ---
        updateProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('profile-phone').value.trim();
            const address = document.getElementById('profile-address').value.trim();
            
            const phoneRegex = /^(?:\+92|0)3[0-9]{2}[0-9]{7}$/;
            if (!phoneRegex.test(phone)) {
                showToast("Please enter a valid Pakistani phone number.", "error");
                return;
            }

            try {
                const userRef = ref(db, `users/${currentUserId}`);
                await update(userRef, { phone, address });
                showToast("Profile updated successfully!", "success");
            } catch (error) {
                console.error("Profile update error:", error);
                showToast("Failed to update profile.", "error");
            }
        });

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;

            if (newPassword.length < 6) {
                showToast("New password must be at least 6 characters.", "error");
                return;
            }

            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(user.email, currentPassword);

            try {
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                showToast("Password updated successfully!", "success");
                changePasswordForm.reset();
            } catch (error) {
                console.error("Password change error:", error);
                showToast("Failed to update password. Check your current password.", "error");
            }
        });

        // --- Notifications Page Logic ---
        async function loadNotifications(userId, userNotifications) {
            const broadcastRef = ref(db, 'notifications');
            const broadcastSnapshot = await get(broadcastRef);
            let allNotifications = [];

            // Get broadcast notifications
            if (broadcastSnapshot.exists()) {
                broadcastSnapshot.forEach(childSnapshot => {
                    const notif = { id: childSnapshot.key, ...childSnapshot.val() };
                    if (notif.targetUser === 'all') {
                        allNotifications.push({ ...notif, isRead: userNotifications[notif.id]?.read || false });
                    }
                });
            }

            // Get personal notifications (assuming they are stored directly under user)
            // In a more robust system, you'd fetch these from a central /notifications node too
            // For now, this structure matches the prompt's implied schema
            
            // Sort by timestamp descending
            allNotifications.sort((a, b) => b.timestamp - a.timestamp);

            renderNotifications(allNotifications);
        }

        function renderNotifications(notifications) {
            notificationsContainer.innerHTML = '';
            if (notifications.length === 0) {
                notificationsContainer.innerHTML = '<p class="text-gray-500">You have no notifications.</p>';
                return;
            }

            notifications.forEach(notif => {
                const isUnread = !notif.isRead;
                const date = new Date(notif.timestamp).toLocaleString();

                const notifElement = document.createElement('div');
                notifElement.className = `timeline-item cursor-pointer ${isUnread ? 'unread' : ''}`;
                notifElement.dataset.id = notif.id;
                notifElement.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="text-sm text-gray-500">${date}</div>
                    <p class="text-gray-800">${notif.message}</p>
                `;
                
                notifElement.addEventListener('click', () => markNotificationAsRead(notif.id));
                notificationsContainer.appendChild(notifElement);
            });
        }

        async function markNotificationAsRead(notificationId) {
            const notifRef = ref(db, `users/${currentUserId}/notifications/${notificationId}`);
            try {
                await set(notifRef, { read: true });
                // The onValue listener will automatically re-render the UI
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }

        // --- Logout Logic ---
        function handleLogout() {
            signOut(auth).catch(error => console.error("Logout Error:", error));
        }
        logoutBtn.addEventListener('click', handleLogout);
        navLogoutBtn.addEventListener('click', handleLogout);

        // --- UI Interactions ---
        userMenuButton.addEventListener('click', () => {
            userMenuDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!userMenu.contains(e.target)) {
                userMenuDropdown.classList.add('hidden');
            }
        });

        // --- Toast Notification Logic ---
        function showToast(message, type = 'success') {
            toastEl.textContent = message;
            toastEl.className = '';
            toastEl.classList.add('show', type);
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        }

        // --- Simple Client-Side Router (from previous parts) ---
        // This part needs to be present to handle page switching
    </script>
</body>
</html>
